<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Concept Map</title>
    <meta name="description" content="A concept map diagram implemented with labeled links and ForceDirectedLayout." />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Copyright 1998-2019 by Northwoods Software Corporation. -->

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gojs/2.0.4/go-debug.js"></script>
    <script id="code">
        function init() {
            if (window.goSamples) goSamples();  // init for these samples -- you don't need to call this
            var $ = go.GraphObject.make;  // for conciseness in defining templates
            myDiagram =
                $(go.Diagram, "myDiagramDiv",  // must name or refer to the DIV HTML element
                    {
                        initialAutoScale: go.Diagram.Uniform,  // an initial automatic zoom-to-fit
                        contentAlignment: go.Spot.Center,  // align document to the center of the viewport
                        layout:
                            $(go.ForceDirectedLayout,  // automatically spread nodes apart
                                { maxIterations: 200, defaultSpringLength: 30, defaultElectricalCharge: 300 })
                    });
            // define each Node's appearance
            myDiagram.nodeTemplate =
                $(go.Node, "Auto",  // the whole node panel
                    { locationSpot: go.Spot.Center },
                    // define the node's outer shape, which will surround the TextBlock
                    $(go.Shape, "Rectangle",
                        { fill: $(go.Brush, "Linear", { 0: "#B0E0E6", 1: "#87CEEB" }), stroke: "black" }),
                    $(go.TextBlock,
                        { font: "bold 10pt helvetica, bold arial, sans-serif", margin: 10 },
                        new go.Binding("text", "text"))
                );
            // replace the default Link template in the linkTemplateMap
            myDiagram.linkTemplate =
                $(go.Link,  // the whole link panel
                    $(go.Shape,  // the link shape
                        { stroke: "black", strokeWidth: 1.5 }),
                    $(go.Shape,  // the arrowhead
                        { toArrow: "standard", stroke: null, scale: 1.5 }),
                    $(go.Panel, "Auto",
                        $(go.Shape,  // the label background, which becomes transparent around the edges
                            {
                                fill: $(go.Brush, "Radial", { 0: "rgb(240, 240, 240)", 0.8: "rgb(240, 240, 240)", 1: "rgba(240, 240, 240, 0)" }),
                                stroke: null
                            }),
                        $(go.TextBlock,  // the label text
                            {
                                textAlign: "center",
                                font: "10pt helvetica, arial, sans-serif",
                                stroke: "#555555",
                                margin: 4
                            },
                            new go.Binding("text", "text"))
                    )
                );
            // create the model for the concept map
            var json = {"nodeDataArray":[{"key":1,"text":"gateway-service"},{"key":2,"text":"temperature-service"},{"key":3,"text":"asset-service"},{"key":4,"text":"climate-control-service"},{"key":5,"text":"fire-service"},{"key":6,"text":"occupancy-service"},{"key":7,"text":"contact-service"},{"key":8,"text":"alert-service"}],"linkDataArray":[{"from":1,"to":2,"text":"1. TemperatureController\n.receiveTemperatureData()"},{"from":2,"to":3,"text":"2. AssetController\n.getEmergencyContacts()"},{"from":2,"to":4,"text":"3. ClimateController\n.create()"},{"from":4,"to":5,"text":"4. FireServiceController\n.receiveFireEvent()"},{"from":5,"to":6,"text":"5. OccupancyController\n.getEmergencyContacts()"},{"from":5,"to":7,"text":"6. ContactController\n.getEmergencyContacts()"},{"from":5,"to":8,"text":"7. AlertController\n.recieveAlert()"}]}
            myDiagram.model = new go.GraphLinksModel(json.nodeDataArray, json.linkDataArray);
        }
    </script>
</head>
<body onload="init()">
<div id="sample">
    <div id="myDiagramDiv" style="background-color: whitesmoke; border: solid 1px black; width: 100%; height: 800px"></div>
</div>
</body>
</html>             {
                        locationSpot: go.Spot.Top,
                        locationObjectName: "SHAPE",
                        minLocation: new go.Point(NaN, LinePrefix - ActivityStart),
                        maxLocation: new go.Point(NaN, 19999),
                        selectionObjectName: "SHAPE",
                        resizable: true,
                        resizeObjectName: "SHAPE",
                        resizeAdornmentTemplate:
                            $(go.Adornment, "Spot",
                                $(go.Placeholder),
                                $(go.Shape,  // only a bottom resize handle
                                    {
                                        alignment: go.Spot.Bottom, cursor: "col-resize",
                                        desiredSize: new go.Size(6, 6), fill: "yellow"
                                    })
                            )
                    },
                    new go.Binding("location", "", computeActivityLocation).makeTwoWay(backComputeActivityLocation),
                    $(go.Shape, "Rectangle",
                        {
                            name: "SHAPE",
                            fill: "white", stroke: "black",
                            width: ActivityWidth,
                            // allow Activities to be resized down to 1/4 of a time unit
                            minSize: new go.Size(ActivityWidth, computeActivityHeight(0.25))
                        },
                        new go.Binding("height", "duration", computeActivityHeight).makeTwoWay(backComputeActivityHeight))
                );
            // define the Message Link template.
            myDiagram.linkTemplate =
                $(MessageLink,  // defined below
                    {selectionAdorned: true, curviness: 0},
                    $(go.Shape, "Rectangle",
                        {stroke: "black"}),
                    $(go.Shape,
                        {toArrow: "OpenTriangle", stroke: "black"}),
                    $(go.TextBlock,
                        {
                            font: "400 9pt Source Sans Pro, sans-serif",
                            segmentIndex: 0,
                            segmentOffset: new go.Point(NaN, NaN),
                            isMultiline: false,
                            editable: true
                        },
                        new go.Binding("text", "text").makeTwoWay())
                );
            // create the graph by reading the JSON data saved in "mySavedModel" textarea element
            load();
        }

        function ensureLifelineHeights(e) {
            // iterate over all Activities (ignore Groups)
            var arr = myDiagram.model.nodeDataArray;
            var max = -1;
            for (var i = 0; i < arr.length; i++) {
                var act = arr[i];
                if (act.isGroup) continue;
                max = Math.max(max, act.start + act.duration);
            }
            if (max > 0) {
                // now iterate over only Groups
                for (var i = 0; i < arr.length; i++) {
                    var gr = arr[i];
                    if (!gr.isGroup) continue;
                    if (max > gr.duration) {  // this only extends, never shrinks
                        myDiagram.model.setDataProperty(gr, "duration", max);
                    }
                }
            }
        }

        // some parameters
        var LinePrefix = 20;  // vertical starting point in document for all Messages and Activations
        var LineSuffix = 30;  // vertical length beyond the last message time
        var MessageSpacing = 20;  // vertical distance between Messages at different steps
        var ActivityWidth = 10;  // width of each vertical activity bar
        var ActivityStart = 5;  // height before start message time
        var ActivityEnd = 5;  // height beyond end message time
        function computeLifelineHeight(duration) {
            return LinePrefix + duration * MessageSpacing + LineSuffix;
        }

        function computeActivityLocation(act) {
            var groupdata = myDiagram.model.findNodeDataForKey(act.group);
            if (groupdata === null) return new go.Point();
            // get location of Lifeline's starting point
            var grouploc = go.Point.parse(groupdata.loc);
            return new go.Point(grouploc.x, convertTimeToY(act.start) - ActivityStart);
        }

        function backComputeActivityLocation(loc, act) {
            myDiagram.model.setDataProperty(act, "start", convertYToTime(loc.y + ActivityStart));
        }

        function computeActivityHeight(duration) {
            return ActivityStart + duration * MessageSpacing + ActivityEnd;
        }

        function backComputeActivityHeight(height) {
            return (height - ActivityStart - ActivityEnd) / MessageSpacing;
        }

        // time is just an abstract small non-negative integer
        // here we map between an abstract time and a vertical position
        function convertTimeToY(t) {
            return t * MessageSpacing + LinePrefix;
        }

        function convertYToTime(y) {
            return (y - LinePrefix) / MessageSpacing;
        }

        // a custom routed Link
        function MessageLink() {
            go.Link.call(this);
            this.time = 0;  // use this "time" value when this is the temporaryLink
        }

        go.Diagram.inherit(MessageLink, go.Link);
        MessageLink.prototype.getLinkPoint = function (node, port, spot, from, ortho, othernode, otherport) {
            var p = port.getDocumentPoint(go.Spot.Center);
            var r = port.getDocumentBounds();
            var op = otherport.getDocumentPoint(go.Spot.Center);
            var data = this.data;
            var time = data !== null ? data.time : this.time;  // if not bound, assume this has its own "time" property
            var aw = this.findActivityWidth(node, time);
            var x = (op.x > p.x ? p.x + aw / 2 : p.x - aw / 2);
            var y = convertTimeToY(time);
            return new go.Point(x, y);
        };
        MessageLink.prototype.findActivityWidth = function (node, time) {
            var aw = ActivityWidth;
            if (node instanceof go.Group) {
                // see if there is an Activity Node at this point -- if not, connect the link directly with the Group's lifeline
                if (!node.memberParts.any(function (mem) {
                    var act = mem.data;
                    return (act !== null && act.start <= time && time <= act.start + act.duration);
                })) {
                    aw = 0;
                }
            }
            return aw;
        };
        MessageLink.prototype.getLinkDirection = function (node, port, linkpoint, spot, from, ortho, othernode, otherport) {
            var p = port.getDocumentPoint(go.Spot.Center);
            var op = otherport.getDocumentPoint(go.Spot.Center);
            var right = op.x > p.x;
            return right ? 0 : 180;
        };
        MessageLink.prototype.computePoints = function () {
            if (this.fromNode === this.toNode) {  // also handle a reflexive link as a simple orthogonal loop
                var data = this.data;
                var time = data !== null ? data.time : this.time;  // if not bound, assume this has its own "time" property
                var p = this.fromNode.port.getDocumentPoint(go.Spot.Center);
                var aw = this.findActivityWidth(this.fromNode, time);
                var x = p.x + aw / 2;
                var y = convertTimeToY(time);
                this.clearPoints();
                this.addPoint(new go.Point(x, y));
                this.addPoint(new go.Point(x + 50, y));
                this.addPoint(new go.Point(x + 50, y + 5));
                this.addPoint(new go.Point(x, y + 5));
                return true;
            } else {
                return go.Link.prototype.computePoints.call(this);
            }
        }
        // end MessageLink
        // A custom LinkingTool that fixes the "time" (i.e. the Y coordinate)
        // for both the temporaryLink and the actual newly created Link
        function MessagingTool() {
            go.LinkingTool.call(this);
            var $ = go.GraphObject.make;
            this.temporaryLink =
                $(MessageLink,
                    $(go.Shape, "Rectangle",
                        {stroke: "magenta", strokeWidth: 2}),
                    $(go.Shape,
                        {toArrow: "OpenTriangle", stroke: "magenta"}));
        };
        go.Diagram.inherit(MessagingTool, go.LinkingTool);
        MessagingTool.prototype.doActivate = function () {
            go.LinkingTool.prototype.doActivate.call(this);
            var time = convertYToTime(this.diagram.firstInput.documentPoint.y);
            this.temporaryLink.time = Math.ceil(time);  // round up to an integer value
        };
        MessagingTool.prototype.insertLink = function (fromnode, fromport, tonode, toport) {
            var newlink = go.LinkingTool.prototype.insertLink.call(this, fromnode, fromport, tonode, toport);
            if (newlink !== null) {
                var model = this.diagram.model;
                // specify the time of the message
                var start = this.temporaryLink.time;
                var duration = 1;
                newlink.data.time = start;
                model.setDataProperty(newlink.data, "text", "msg");
                // and create a new Activity node data in the "to" group data
                var newact = {
                    group: newlink.data.to,
                    start: start,
                    duration: duration
                };
                model.addNodeData(newact);
                // now make sure all Lifelines are long enough
                ensureLifelineHeights();
            }
            return newlink;
        };
        // end MessagingTool
        // A custom DraggingTool that supports dragging any number of MessageLinks up and down --
        // changing their data.time value.
        function MessageDraggingTool() {
            go.DraggingTool.call(this);
        }

        go.Diagram.inherit(MessageDraggingTool, go.DraggingTool);
        // override the standard behavior to include all selected Links,
        // even if not connected with any selected Nodes
        MessageDraggingTool.prototype.computeEffectiveCollection = function (parts, options) {
            var result = go.DraggingTool.prototype.computeEffectiveCollection.call(this, parts, options);
            // add a dummy Node so that the user can select only Links and move them all
            result.add(new go.Node(), new go.DraggingInfo(new go.Point()));
            // normally this method removes any links not connected to selected nodes;
            // we have to add them back so that they are included in the "parts" argument to moveParts
            parts.each(function (part) {
                if (part instanceof go.Link) {
                    result.add(part, new go.DraggingInfo(part.getPoint(0).copy()));
                }
            })
            return result;
        }
        // override to allow dragging when the selection only includes Links
        MessageDraggingTool.prototype.mayMove = function () {
            return !this.diagram.isReadOnly && this.diagram.allowMove;
        }
        // override to move Links (which are all assumed to be MessageLinks) by
        // updating their Link.data.time property so that their link routes will
        // have the correct vertical position
        MessageDraggingTool.prototype.moveParts = function (parts, offset, check) {
            go.DraggingTool.prototype.moveParts.call(this, parts, offset, check);
            var it = parts.iterator;
            while (it.next()) {
                if (it.key instanceof go.Link) {
                    var link = it.key;
                    var startY = it.value.point.y;  // DraggingInfo.point.y
                    var y = startY + offset.y;  // determine new Y coordinate value for this link
                    var cellY = this.gridSnapCellSize.height;
                    y = Math.round(y / cellY) * cellY;  // snap to multiple of gridSnapCellSize.height
                    var t = Math.max(0, convertYToTime(y));
                    link.diagram.model.set(link.data, "time", t);
                    link.invalidateRoute();
                }
            }
        }
        // end MessageDraggingTool
        // Show the diagram's model in JSON format
        function save() {
            document.getElementById("mySavedModel").value = myDiagram.model.toJson();
            myDiagram.isModified = false;
        }

        function load() {
            myDiagram.model = go.Model.fromJson(document.getElementById("mySavedModel").value);
        }
    </script>
</head>
<body onload="init()">
<div id="sample">
    <div id="myDiagramDiv" style="border: solid 1px black; width: 100%; height: 600px"></div>
    <div>
        <!-- <div>
             <button id="SaveButton" onclick="save()">Save</button>
             <button onclick="load()">Load</button>
         </div>-->
        <textarea id="mySavedModel" style="width:100%;height:240px" hidden>
{"class":"go.GraphLinksModel","nodeDataArray":[{"group":"asset-service","start":2,"duration":1},{"group":"occupancy-service","start":7,"duration":1},{"group":"contact-service","start":10,"duration":1},{"group":"alert-service","start":13,"duration":1},{"group":"fire-service","start":6,"duration":9},{"group":"climate-control-service","start":5,"duration":11},{"group":"temperature-service","start":1,"duration":16},{"group":"gateway-service","start":0,"duration":18},{"key":"gateway-service","text":"gateway-service","isGroup":true,"loc":"0 0","duration":19},{"key":"temperature-service","text":"temperature-service","isGroup":true,"loc":"150 0","duration":19},{"key":"asset-service","text":"asset-service","isGroup":true,"loc":"300 0","duration":19},{"key":"climate-control-service","text":"climate-control-service","isGroup":true,"loc":"450 0","duration":19},{"key":"fire-service","text":"fire-service","isGroup":true,"loc":"600 0","duration":19},{"key":"occupancy-service","text":"occupancy-service","isGroup":true,"loc":"750 0","duration":19},{"key":"contact-service","text":"contact-service","isGroup":true,"loc":"900 0","duration":19},{"key":"alert-service","text":"alert-service","isGroup":true,"loc":"1050 0","duration":19}],"linkDataArray":[{"from":"gateway-service","to":"temperature-service","text":"post /","time":1},{"from":"temperature-service","to":"asset-service","text":"get /{sensorid}","time":2},{"from":"asset-service","to":"temperature-service","time":3},{"from":"temperature-service","to":"climate-control-service","text":"post /","time":5},{"from":"climate-control-service","to":"fire-service","text":"post /","time":6},{"from":"fire-service","to":"occupancy-service","text":"get /{roomid}","time":7},{"from":"occupancy-service","to":"fire-service","time":8},{"from":"fire-service","to":"contact-service","text":"get /{roomid}","time":10},{"from":"contact-service","to":"fire-service","time":11},{"from":"fire-service","to":"alert-service","text":"post /","time":13},{"from":"alert-service","to":"fire-service","time":14},{"from":"fire-service","to":"climate-control-service","time":15},{"from":"climate-control-service","to":"temperature-service","time":16},{"from":"temperature-service","to":"gateway-service","time":17}]}
    </textarea>
    </div>
</div>
</body>
</html>